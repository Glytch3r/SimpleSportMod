--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire										                      		 |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/			       				          |
|                       		                                    														 	 		 	 		 	 |
|                       	Discord:    glytch3r															     	     	     	     	     	          |
|                       		                                    														 	                   |
|                       	Support:    https://ko-fi.com/glytch3r														    	                   |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

-----------------------            ---------------------------
SimpleSportMod = SimpleSportMod or {}

SimpleSportMod.SportItems = {
   ["Base.SimpleSportMod_Baseball"] = true,
   ["Base.SimpleSportMod_Basketball"] = true,
   ["Base.SimpleSportMod_GolfBall"] = true,
   ["Base.SimpleSportMod_TennisBall"] = true,
   ["Base.SimpleSportMod_Football"] = true,
   ["Base.SimpleSportMod_PoolBall"] = true,
   ["Base.SimpleSportMod_SoccerBall"] = true,
}

SimpleSportMod.VanillaSportItems = {
   ["Base.Baseball"] = true,
   ["Base.Basketball"] = true,
   ["Base.GolfBall"] = true,
   ["Base.TennisBall"] = true,
   ["Base.Football"] = true,
   ["Base.Football2"] = true,
   ["Base.PoolBall"] = true,
   ["Base.SoccerBall"] = true,
}

SimpleSportMod.VanillaToMods = {
   ["Base.Baseball"]    = "Base.SimpleSportMod_Baseball",
   ["Base.Basketball"]  = "Base.SimpleSportMod_Basketball",
   ["Base.GolfBall"]    = "Base.SimpleSportMod_GolfBall",
   ["Base.TennisBall"]  = "Base.SimpleSportMod_TennisBall",
   ["Base.Football"]    = "Base.SimpleSportMod_Football",
   ["Base.Football2"]   = "Base.SimpleSportMod_Football",
   ["Base.PoolBall"]    = "Base.SimpleSportMod_PoolBall",
   ["Base.SoccerBall"]  = "Base.SimpleSportMod_SoccerBall",
}
function SimpleSportMod.isSportItem(item)
   if not item then return end
   local fType = item:getFullType()
   return  fType and SimpleSportMod.SportItems[fType] or SimpleSportMod.VanillaSportItems[fType]
end
function SimpleSportMod.getSportItem(sq)
   if not sq then return nil end
   local worldObjects = sq:getWorldObjects()
   for i = 0, worldObjects:size() - 1 do
      local obj = worldObjects:get(i)
      local item = obj:getItem()
      if item then
         local fType = item:getFullType()
         if SimpleSportMod.SportItems[fType] or SimpleSportMod.VanillaSportItems[fType] then
            return item, obj, sq
         end
      end
   end
   return nil
end


function SimpleSportMod.convert(item, fType)
   if not item or not fType then return item end
   local fType2 = SimpleSportMod.VanillaToMods[fType]
   if not fType2 then return item end

   local inv = getPlayer():getInventory()
   local newItem = inv:AddItem(fType2)
   if not newItem then return item end

   newItem:setCondition(item:getCondition())
   newItem:setName(item:getName())
   local oldData = item:getModData()
   if oldData and type(oldData) == "table" then
      for k, v in pairs(oldData) do
         newItem:getModData()[k] = v
      end
   end

   inv:Remove(item)
   return newItem
end

SimpleSportMod.PickupAndEquip = ISBaseTimedAction:derive("SimpleSportMod.PickupAndEquip")

function SimpleSportMod.PickupAndEquip:isValid() return true end
function SimpleSportMod.PickupAndEquip:update() end
function SimpleSportMod.PickupAndEquip:stop() ISBaseTimedAction.stop(self) end
function SimpleSportMod.PickupAndEquip:perform()
   self.square:removeWorldObject(self.obj)

   local finalItem
   if SimpleSportMod.VanillaSportItems[self.fType] then
      finalItem = SimpleSportMod.convert(self.item, self.fType)
   else
      finalItem = self.inv:AddItem(self.item)
   end

   if finalItem then
      ISTimedActionQueue.add(ISEquipWeaponAction:new(self.character, finalItem, 50, true, false))
   --else
      --self.character:Say("Pickup failed.")
   end

   ISBaseTimedAction.perform(self)
end
function SimpleSportMod.PickupAndEquip:new(character, item, obj, square, fType)
   local o = ISBaseTimedAction.new(self, character)
   o.item = item
   o.obj = obj
   o.square = square
   o.fType = fType
   o.character = character
   o.inv = character:getInventory()
   o.maxTime = 2
   return o
end

function SimpleSportMod.keypress(key)
   if not isIngameState() or key ~= getCore():getKey("Pick Up") then return end

   local pl = getPlayer()
   local item, obj, sq
   local fType

   item, obj, sq = SimpleSportMod.getSportItem(pl:getSquare())

   if not item then
      item, obj, sq = SimpleSportMod.getSportItem(pl:getSquare():getAdjacentSquare(pl:getDir()))
   end

   if not item then

      local PickUpDistance = SandboxVars.SimpleSportMod.PickUpDistance or 2
      local rad, x, y, z = PickUpDistance, pl:getX(), pl:getY(), pl:getZ()
      local bestDist = math.huge
      for dx = -rad, rad do
         for dy = -rad, rad do
            local ssq = getCell():getOrCreateGridSquare(x + dx, y + dy, z)
            local i, o, s = SimpleSportMod.getSportItem(ssq)
            if i then
               local px, py = pl:getX(), pl:getY()
               local sx, sy = ssq:getX(), ssq:getY()
               local dist = (px - sx)^2 + (py - sy)^2
               if dist < bestDist then
                  bestDist = dist
                  item, obj, sq = i, o, s
               end
            end
         end
      end
   end

   if not item or not obj or not sq then
--[[       if getCore():getDebug() then
         pl:Say("Nothing to pick up.")
      end ]]
      return key
   end

   fType = item:getFullType()

   ISTimedActionQueue.add(ISWalkToTimedAction:new(pl, sq))
	if tostring(WeaponType.getWeaponType(pl)) ~= "barehand" then  
      local pr = pl:getPrimaryHandItem()
      if pr then
         ISTimedActionQueue.add(ISUnequipAction:new(pl, pr, 1));
      end
   end

   if item then
      if tostring(WeaponType.getWeaponType(pl)) == "barehand" then  
         local fType = item:getFullType()
         if fType then
            if SimpleSportMod.SportItems[fType] then
               ISTimedActionQueue.add(ISGrabItemAction:new(pl, item:getWorldItem(), 20));
               ISTimedActionQueue.add(ISEquipWeaponAction:new(pl, item, 20, true));
            end
         end
      end
   end


   return key
end
Events.OnKeyPressed.Add(SimpleSportMod.keypress)

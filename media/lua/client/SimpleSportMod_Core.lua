--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire										                      		 |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/			       				          |
|                       		                                    														 	 		 	 		 	 |
|                       	Discord:    glytch3r															     	     	     	     	     	          |
|                       		                                    														 	                   |
|                       	Support:    https://ko-fi.com/glytch3r														    	                   |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

-----------------------            ---------------------------
SimpleSportMod = SimpleSportMod or {}

SimpleSportMod.SportItems = {
   ["Base.SimpleSportMod_Baseball"] = true,
   ["Base.SimpleSportMod_Basketball"] = true,
   ["Base.SimpleSportMod_GolfBall"] = true,
   ["Base.SimpleSportMod_TennisBall"] = true,
   ["Base.SimpleSportMod_Football"] = true,
   ["Base.SimpleSportMod_PoolBall"] = true,
   ["Base.SimpleSportMod_SoccerBall"] = true,
}

SimpleSportMod.VanillaSportItems = {
   ["Base.Baseball"] = true,
   ["Base.Basketball"] = true,
   ["Base.GolfBall"] = true,
   ["Base.TennisBall"] = true,
   ["Base.Football"] = true,
   ["Base.Football2"] = true,
   ["Base.PoolBall"] = true,
   ["Base.SoccerBall"] = true,
}

SimpleSportMod.VanillaToMods = {
   ["Base.Baseball"]    = "Base.SimpleSportMod_Baseball",
   ["Base.Basketball"]  = "Base.SimpleSportMod_Basketball",
   ["Base.GolfBall"]    = "Base.SimpleSportMod_GolfBall",
   ["Base.TennisBall"]  = "Base.SimpleSportMod_TennisBall",
   ["Base.Football"]    = "Base.SimpleSportMod_Football",
   ["Base.Football2"]   = "Base.SimpleSportMod_Football",
   ["Base.PoolBall"]    = "Base.SimpleSportMod_PoolBall",
   ["Base.SoccerBall"]  = "Base.SimpleSportMod_SoccerBall",
}
-----------------------            ---------------------------
function SimpleSportMod.init(plNum, pl)
    if isIngameState() then
      pl:getModData()['SimpleSportMod'] =  pl:getModData()['SimpleSportMod'] or {}
      pl:getModData()['SimpleSportMod']['isPreparedToCatch'] = false
	end
end
Events.OnCreatePlayer.Add(SimpleSportMod.init)
-----------------------            ---------------------------
function SimpleSportMod.isSportItem(item)
   local fType = SimpleSportMod.getFType(item)
   return fType and SimpleSportMod.SportItems[fType] or false
end

function SimpleSportMod.getFType(item)
   if not item then return nil end
   return (item.getFullType and item:getFullType())
       or (item.getWorldItem and item:getWorldItem() and item:getWorldItem():getFullType())
end
-----------------------            ---------------------------
function SimpleSportMod.getSportItem(sq)
   sq = sq or getPlayer():getCurrentSquare()
   if not sq then return nil end

   local worldObjects = sq:getWorldObjects()
   for i = 0, worldObjects:size() - 1 do
      local obj = worldObjects:get(i)
      local item = obj and obj:getItem()

      if item and SimpleSportMod.isSportItem(item) then
         item = SimpleSportMod.convert(item) 
         local fType = SimpleSportMod.getFType(item) or item:getFullType()
         if fType then print(fType) end
         return item, obj, sq
      end
   end
   return nil
end

function SimpleSportMod.findSportItem(sq)
   local pl = getPlayer()
   local rad = SandboxVars.SimpleSportMod.PickUpDistance or 3
   sq = sq or pl:getCurrentSquare()
   if not sq then return nil end

   local cx, cy, cz = sq:getX(), sq:getY(), sq:getZ()
   local closestItem, closestObj, closestSq
   local bestDist = math.huge

   for dx = -rad, rad do
      for dy = -rad, rad do
         local checkSq = getCell():getGridSquare(cx + dx, cy + dy, cz)
         if checkSq then
            local worldObjects = checkSq:getWorldObjects()
            for i = 0, worldObjects:size() - 1 do
               local obj = worldObjects:get(i)
               local item = obj and obj:getItem()

               if item and SimpleSportMod.isSportItem(item) then
                  item = SimpleSportMod.convert(item) 

                  local px, py = pl:getX(), pl:getY()
                  local sx, sy = checkSq:getX(), checkSq:getY()
                  local dist = (px - sx) ^ 2 + (py - sy) ^ 2

                  if dist < bestDist then
                     bestDist = dist
                     closestItem, closestObj, closestSq = item, obj, checkSq
                  end
               end
            end
         end
      end
   end

   return closestItem, closestObj, closestSq
end
-----------------------            ---------------------------

function SimpleSportMod.convert(item, fType)
   fType = fType or SimpleSportMod.getFType(item)
   if not item or not fType then return item end

   if SimpleSportMod.VanillaToMods[fType] == nil or fType == SimpleSportMod.VanillaToMods[fType] then
      return item
   end

   local pl = getPlayer()
   local sq = item:getWorldItem() and item:getWorldItem():getSquare()
   if not sq then return item end

   local newItem = sq:AddWorldInventoryItem(SimpleSportMod.VanillaToMods[fType], 0, 0, 0)
   if not newItem then return item end

   newItem:setCondition(item:getCondition())
   newItem:setName(item:getName())

   local oldData = item:getModData()
   if type(oldData) == "table" then
      for k, v in pairs(oldData) do
         newItem:getModData()[k] = v
      end
   end

   ISRemoveItemTool.removeItem(item, pl:getPlayerNum())
   return newItem
end
-----------------------            ---------------------------

function SimpleSportMod.keypress(key)
   if not isIngameState() then return end
   local pl = getPlayer()

   if key == getCore():getKey("Catch") then
      local dur = SandboxVars.SimpleSportMod.CatchWindow or 3
      SimpleSportMod.setCatchPrepare(pl, true)
      SimpleSportMod.instaCatchAction(pl)

      timer:Simple(dur, function()
         SimpleSportMod.setCatchPrepare(pl, false)
      end)
   end

   if key == getCore():getKey("Pick Up") then
      local item, obj, sq = SimpleSportMod.findSportItem(pl:getSquare())

      if not item then
         return key
      end

      local fType = item:getFullType()

      ISTimedActionQueue.add(ISWalkToTimedAction:new(pl, sq))

      if tostring(WeaponType.getWeaponType(pl)) ~= "barehand" then
         local pr = pl:getPrimaryHandItem()
         if pr then
            ISTimedActionQueue.add(ISUnequipAction:new(pl, pr, 1))
         end
      end

      if SimpleSportMod.SportItems[fType] then
         ISTimedActionQueue.add(ISGrabItemAction:new(pl, item:getWorldItem(), 20))
         ISTimedActionQueue.add(ISEquipWeaponAction:new(pl, item, 20, true))
      end
   end

   return key
end

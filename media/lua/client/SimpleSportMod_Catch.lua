--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire										                      		 |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/			       				          |
|                       		                                    														 	 		 	 		 	 |
|                       	Discord:    glytch3r															     	     	     	     	     	          |
|                       		                                    														 	                   |
|                       	Support:    https://ko-fi.com/glytch3r														    	                   |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

-----------------------            ---------------------------

SimpleSportMod = SimpleSportMod or {}



function SimpleSportMod.getData(pl)   
   pl = pl or getPlayer()
   return pl:getModData()['SimpleSportMod']
end

function SimpleSportMod.isPreparedToCatch(pl)   
   pl = pl or getPlayer()
   local data = SimpleSportMod.getData(pl) or {}
   return data['isPreparedToCatch']   
end

function SimpleSportMod.setCatchPrepare(pl, bool)   
   pl = pl or getPlayer()
   local data = SimpleSportMod.getData(pl) or {}
   data['isPreparedToCatch'] = bool or not  SimpleSportMod.isPreparedToCatch(pl)  
   if bool then
      SimpleSportMod.setReachMarker(sq)
      pl:playEmote("surrender")
   else
      pl:playEmote("idle")
   end
   return bool
end


--[[ 
function SimpleSportMod.cancelCatch(pl)
   pl:getModData()['SimpleSportMod']['isPreparedToCatch'] = false   
end
Events.OnPlayerMove.Add(OnPlayerMove)
 ]]

function SimpleSportMod.autoCatchHandler(pl)
   pl = pl or getPlayer()
   if not pl then return end 

   if not SimpleSportMod.isPreparedToCatch(pl) then return end 

   local csq = pl:getCurrentSquare()
   if not csq then return end
   
   local item, ball , targSq  = SimpleSportMod.findSportItem(csq)
   if not item then return end
   
   SimpleSportMod.instaCatch(pl, item)
end
Events.OnPlayerUpdate.Add(SimpleSportMod.autoCatchHandler)
-----------------------            ---------------------------
 function SimpleSportMod.instaCatch(pl, item)

      if not pl or not item then return end 
   
      if SimpleSportMod.isPreparedToCatch(pl)  then
         if not pl:getCharacterActions():isEmpty() then
            pl:StopAllActionQueue()
         end
      
         ISTimedActionQueue.add(ISGrabItemAction:new(pl, item:getWorldItem(), 0));
         ISTimedActionQueue.add(ISEquipWeaponAction:new(pl, item, 0, true));
         SimpleSportMod.setCatchPrepare(pl, false)   
      end
end


--[[ function SimpleSportMod.instaCatch(pl, item)
   pl = pl or getPlayer() 
   local csq = pl:getCurrentSquare()
   if not csq then return end
   item = item or SimpleSportMod.getSportItem(csq)
   if item then
      if tostring(WeaponType.getWeaponType(pl)) == "barehand" then  
         local fType = item:getFullType()
         if fType then
            if SimpleSportMod.SportItems[fType] then
               if SimpleSportMod.isPreparedToCatch(pl)  then
                  if not pl:getCharacterActions():isEmpty() then
                     pl:StopAllActionQueue()
                  end
               
                  ISTimedActionQueue.add(ISGrabItemAction:new(pl, item:getWorldItem(), 0));
                  ISTimedActionQueue.add(ISEquipWeaponAction:new(pl, item, 0, true));
                  SimpleSportMod.setCatchPrepare(pl, false)   
               end
            end
         end
      end
   end
end ]]
-----------------------            ---------------------------


function SimpleSportMod.setReachMarker(sq)
   local rad = SandboxVars.SimpleSportMod.PickUpDistance or 3
   local dur = SandboxVars.SimpleSportMod.CatchWindow or 3
   local pl = getPlayer()
   sq = sq or pl:getCurrentSquare() 
   local ReachMarker = ReachMarker or getWorldMarkers():addGridSquareMarker("circle_highlight_2", "circle_highlight_2", sq, 0, 0, 0.31, true, rad)

   timer:Simple(dur, function()
      if ReachMarker then ReachMarker:remove() end
   end)
end

-----------------------            ---------------------------
function SimpleSportMod.instaCatchAction(pl)
   pl = pl or getPlayer()
   SimpleSportMod.setCatchPrepare(pl, true)
   if tostring(WeaponType.getWeaponType(pl)) ~= "barehand" then return end
   if not SimpleSportMod.isPreparedToCatch(pl) then return end

   local dur = SandboxVars.SimpleSportMod.CatchWindow or 3
   timer:Simple(dur, function()
      SimpleSportMod.setCatchPrepare(pl, false)
   end)
   ISTimedActionQueue.add(ISWaitForCatchAction:new(pl))
end

-----------------------            ---------------------------
ISWaitForCatchAction = ISBaseTimedAction:derive("ISWaitForCatchAction")

function ISWaitForCatchAction:isValid()
   return SimpleSportMod.isPreparedToCatch(self.pl)
end

function ISWaitForCatchAction:start()
   SimpleSportMod.setCatchPrepare(self.pl, true)
end

function ISWaitForCatchAction:update()
   local item = SimpleSportMod.getSportItem(self.pl:getCurrentSquare())
   if item and SimpleSportMod.isSportItem(item) then
      self.targetItem = item
      self:forceComplete()
   end
end

function ISWaitForCatchAction:perform()
   if self.targetItem then
      ISTimedActionQueue.add(ISGrabItemAction:new(self.pl, self.targetItem:getWorldItem(), 0))
      ISTimedActionQueue.add(ISEquipWeaponAction:new(self.pl, self.targetItem, 0, true))
   end
   SimpleSportMod.setCatchPrepare(self.pl, false)
   ISBaseTimedAction.perform(self)
end

function ISWaitForCatchAction:forceStop()
   SimpleSportMod.setCatchPrepare(self.pl, false) 
   ISBaseTimedAction.stop(self)
end

function ISWaitForCatchAction:new(pl)
   local o = {}
   setmetatable(o, self)
   self.__index = self
   o.pl = pl
   o.targetItem = nil
   local t = SandboxVars.SimpleSportMod.CatchWindow or 3
   o.maxTime = t * 60
   o.stopOnWalk = true
   o.stopOnRun = true
   o.forceProgressBar = false
   return o
end



--[[ 
Commands.SimpleSportMod.DropPoint = function(player, args)
    local playerId = player:getOnlineID();
    sendServerCommand("SimpleSportMod", "DropPoint", {id = playerId, dropPointX =  args.dropPointX, dropPointY =  args.dropPointY, dropPointZ =  args.dropPointZ})
end
 ]]